// ==UserScript==
// @name               AboutCG Auto Video
// @name:zh-CN         AboutCG è§†é¢‘è‡ªåŠ¨æ’­æ”¾
// @namespace          yueby.aboutcg
// @version            0.1.0
// @author             Yueby
// @description        A userscript for auto-playing videos on AboutCG
// @description:zh-CN  AboutCG ç½‘ç«™è§†é¢‘è‡ªåŠ¨æ’­æ”¾è„šæœ¬
// @icon               https://vitejs.dev/logo.svg
// @match              https://www.aboutcg.org/play*
// ==/UserScript==

(function () {
	'use strict';

	const t=".pv-cover .pv-icon-btn-play",s=".pv-playpause",e=".pv-time-current",n="pv-icon-btn-play",i="pv-icon-btn-pause",r=".cg-player-menu";class a{static async waitForElement(t,s=15e3){return new Promise(e=>{let n=null,i=0;const r=()=>{const s=document.querySelector(t);s?n===s?(i++,3>i||(a.disconnect(),clearTimeout(c),e(s))):(n=s,i=1):(n=null,i=0);},a=new MutationObserver(r);a.observe(document.body,{childList:true,subtree:true});const c=setTimeout(()=>{a.disconnect(),e(n);},s);r();})}static isElementVisible(t){return !!t&&document.body.contains(t)&&"none"!==t.style.display}static safeClick(t){return !(!t||!this.isElementVisible(t)||(t.click(),0))}static getTextContent(t){return t?.textContent?.trim()||""}static queryText(t,s){return this.getTextContent(t.querySelector(s))}}class c{static info(t,...s){}static success(t,...s){}static error(t,...s){}static warn(t,...s){}static debug(t,...s){}static special(t,s,...e){}}class o{cachedCourseData=null;parse(t=false){if(this.cachedCourseData&&!t)return this.cachedCourseData;const s=[];let e;return document.querySelectorAll(".cg-play-chapter-section").forEach(t=>{const n=parseInt(a.queryText(t,".cg-play-chapter-index")||"0"),i=a.queryText(t,".cg-play-chapter-title .cg-player-text2"),r=a.queryText(t,".cg-play-chapter-title .cg-player-text1");if(!i)return;const c=[];t.querySelectorAll(".cg-play-node").forEach((t,s)=>{const i=a.queryText(t,".cg-player-text2"),r=a.queryText(t,".cg-f-fe-c span"),o=t.querySelector(".cg-textp"),l=a.getTextContent(o).includes("æ­£åœ¨æ’­æ”¾");i&&(l&&(e={chapterIndex:n,lessonIndex:s,lessonName:i}),c.push({name:i,duration:r,isPlaying:l,index:s,element:t}));}),s.push({index:n,name:i,duration:r,lessons:c});}),this.cachedCourseData={chapters:s,currentLesson:e},this.cachedCourseData}clearCache(){this.cachedCourseData=null;}getCurrentPosition(t){if(!t.currentLesson)return null;const{chapterIndex:s,lessonIndex:e}=t.currentLesson,n=t.chapters.findIndex(t=>t.index===s);if(-1===n)return null;const i=t.chapters[n],r=i.lessons[e];if(!r)return null;const a={current:{chapter:i,lesson:r,chapterIndex:n,lessonIndex:e}};if(e>0)a.previous={chapter:i,lesson:i.lessons[e-1],chapterIndex:n,lessonIndex:e-1};else if(n>0){const s=t.chapters[n-1],e=s.lessons.length-1;0>e||(a.previous={chapter:s,lesson:s.lessons[e],chapterIndex:n-1,lessonIndex:e});}if(e<i.lessons.length-1)a.next={chapter:i,lesson:i.lessons[e+1],chapterIndex:n,lessonIndex:e+1};else if(n<t.chapters.length-1){const s=t.chapters[n+1];s.lessons.length>0&&(a.next={chapter:s,lesson:s.lessons[0],chapterIndex:n+1,lessonIndex:0});}return a}getNextLesson(t){const s=this.getCurrentPosition(t);return s?.next?.lesson||null}getPreviousLesson(t){const s=this.getCurrentPosition(t);return s?.previous?.lesson||null}logCourseData(t){if(c.info("è¯¾ç¨‹æ•°æ®è§£æå®Œæˆ"),c.info("ç« èŠ‚æ€»æ•°: "+t.chapters.length),t.chapters.forEach(t=>{c.info(`ç¬¬${t.index}ç« : ${t.name} (${t.duration})`),c.info("  - å°èŠ‚æ•°: "+t.lessons.length),t.lessons.forEach((t,s)=>{const e=t.isPlaying?"â–¶ï¸ ":"";c.info(`  ${s+1}. ${e}${t.name} (${t.duration})`);});}),t.currentLesson){c.info(`å½“å‰æ’­æ”¾: ç¬¬${t.currentLesson.chapterIndex}ç«  - ${t.currentLesson.lessonName}`);const s=this.getCurrentPosition(t);s&&(c.info("å°èŠ‚å®šä½ä¿¡æ¯:"),c.info(`  å½“å‰: ç¬¬${s.current.chapter.index}ç«  ç¬¬${s.current.lessonIndex+1}èŠ‚ - ${s.current.lesson.name}`),s.previous?c.info(`  ä¸Šä¸€èŠ‚: ç¬¬${s.previous.chapter.index}ç«  ç¬¬${s.previous.lessonIndex+1}èŠ‚ - ${s.previous.lesson.name}`):c.info("  ä¸Šä¸€èŠ‚: æ— ï¼ˆå·²æ˜¯ç¬¬ä¸€èŠ‚ï¼‰"),s.next?c.info(`  ä¸‹ä¸€èŠ‚: ç¬¬${s.next.chapter.index}ç«  ç¬¬${s.next.lessonIndex+1}èŠ‚ - ${s.next.lesson.name}`):c.info("  ä¸‹ä¸€èŠ‚: æ— ï¼ˆå·²æ˜¯æœ€åä¸€èŠ‚ï¼‰"));}}}class l{observer=null;callbacks={};courseDataProvider;currentPlayingLesson=null;constructor(t){this.courseDataProvider=t;}setCallbacks(t){this.callbacks={...this.callbacks,...t};}start(){const t=document.querySelector(r);t&&(this.currentPlayingLesson=this.findCurrentPlayingLesson(this.courseDataProvider.parse()),this.observer=new MutationObserver(()=>this.handleCourseMenuChange()),this.observer.observe(t,{childList:true,subtree:true,attributes:true,attributeFilter:["class"]}));}stop(){this.observer?.disconnect(),this.observer=null;}handleCourseMenuChange(){const t=this.findCurrentPlayingLesson(this.courseDataProvider.parse(true));if(t&&t.element!==this.currentPlayingLesson?.element){const s=this.currentPlayingLesson;this.currentPlayingLesson=t,this.callbacks.onLessonChange?.(t,s||void 0);}}findCurrentPlayingLesson(t){for(const s of t.chapters){const t=s.lessons.find(t=>t.isPlaying);if(t)return t}return null}getCurrentLesson(){return this.currentPlayingLesson}}class h{async smartClick(){const e=await a.waitForElement(t,15e3);if(e&&a.isElementVisible(e)){const s=document.querySelector(t);if(s&&a.safeClick(s))return c.success("å·²ç‚¹å‡»å°é¢æ’­æ”¾æŒ‰é’®"),true}await new Promise(t=>setTimeout(t,1e3));const i=document.querySelector(s);return i?.classList.contains(n)&&a.safeClick(i)?(c.success("å·²ç‚¹å‡»æ§åˆ¶æ æ’­æ”¾æŒ‰é’®"),true):(c.error("è‡ªåŠ¨æ’­æ”¾å¤±è´¥"),false)}isPlaying(){const t=document.querySelector(s);return t?.classList.contains(i)||false}}class u{static parseTimeToSeconds(t){const s=t.split(":").map(Number);return 3===s.length?3600*s[0]+60*s[1]+s[2]:2===s.length?60*s[0]+s[1]:0}static formatSeconds(t){const s=Math.floor(t/3600),e=Math.floor(t%3600/60),n=Math.floor(t%60),i=t=>t.toString().padStart(2,"0");return s>0?`${i(s)}:${i(e)}:${i(n)}`:`${i(e)}:${i(n)}`}static calculatePercentage(t,s){return s>0?(t/s*100).toFixed(2):"0.00"}static isTimeClose(t,s,e){return e>=Math.abs(t-s)}}class d{observers=[];callbacks={};lastTime="";hasEnded=false;boundTimeElement=null;checkInterval=null;setCallbacks(t){this.callbacks={...this.callbacks,...t};}start(){this.bindObservers(),this.startContainerObserver(),this.startPeriodicCheck();}stop(){this.cleanup(),this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=null);}rebind(){this.boundTimeElement=null,this.bindObservers();}bindObservers(){const t=document.querySelector(e),n=document.querySelector(".pv-time-duration"),i=document.querySelector(s);if(!t||!n||this.boundTimeElement===t)return;this.cleanup(),this.boundTimeElement=t,this.hasEnded=false,this.lastTime="";const r=new MutationObserver(()=>this.handleTimeUpdate(t,n));if(r.observe(t,{childList:true,characterData:true,subtree:true}),this.observers.push(r),i){const t=new MutationObserver(()=>this.handleStateChange(i));t.observe(i,{attributes:true,attributeFilter:["class"]}),this.observers.push(t);}}handleTimeUpdate(t,s){const e=t.textContent?.trim()||"00:00",n=s.textContent?.trim()||"00:00";if(e===this.lastTime)return;this.lastTime=e;const i=u.parseTimeToSeconds(e),r=u.parseTimeToSeconds(n),a=parseFloat(u.calculatePercentage(i,r));c.info(`æ’­æ”¾æ—¶é—´: ${e} / ${n} (${a.toFixed(2)}%)`),this.callbacks.onTimeUpdate?.(e,n,a),!this.hasEnded&&r>0&&u.isTimeClose(i,r,1)&&(this.hasEnded=true,c.special("ğŸ‰","è§†é¢‘æ’­æ”¾å®Œæˆï¼"),this.callbacks.onPlayEnd?.()),this.hasEnded&&r-5>i&&(this.hasEnded=false);}handleStateChange(t){t.classList.contains(n)?(c.info("è§†é¢‘å·²æš‚åœ"),this.callbacks.onStateChange?.("paused")):t.classList.contains(i)&&this.callbacks.onStateChange?.("playing");}startContainerObserver(){const t=document.querySelector("#players");if(!t)return;const s=new MutationObserver(()=>{const t=document.querySelector(e);t&&this.boundTimeElement!==t&&this.bindObservers();});s.observe(t,{childList:true,subtree:true}),this.observers.push(s);}startPeriodicCheck(){this.checkInterval=setInterval(()=>{document.querySelector(e)&&!this.boundTimeElement&&this.bindObservers();},3e3);}cleanup(){this.observers.forEach(t=>t.disconnect()),this.observers=[],this.boundTimeElement=null;}}const p=new class{courseDataProvider;playerMonitor;courseObserver;playButtonService;constructor(){this.courseDataProvider=new o,this.playerMonitor=new d,this.courseObserver=new l(this.courseDataProvider),this.playButtonService=new h;}async initialize(){if(c.info("AboutCG Auto Video å·²åŠ è½½"),await a.waitForElement(r)){const t=this.courseDataProvider.parse();this.courseDataProvider.logCourseData(t);}await a.waitForElement(e)?(this.playerMonitor.setCallbacks({onPlayEnd:()=>this.handlePlayEnd()}),this.courseObserver.setCallbacks({onLessonChange:(t,s)=>this.handleLessonChange(t,s)}),this.courseObserver.start(),await a.waitForElement(`${t}, ${s}`,1e4)?setTimeout(()=>this.startAutoPlay(),500):c.error("æ’­æ”¾æŒ‰é’®åŠ è½½è¶…æ—¶")):c.error("æ’­æ”¾å™¨æ§ä»¶åŠ è½½è¶…æ—¶");}async startAutoPlay(){this.playerMonitor.start(),this.playButtonService.isPlaying()||await this.playButtonService.smartClick();}handlePlayEnd(){setTimeout(()=>this.playNextLesson(),3e3);}async handleLessonChange(t,s){c.info(`å°èŠ‚åˆ‡æ¢: ${s?.name||"æ— "} -> ${t.name}`),await new Promise(t=>setTimeout(t,2e3)),this.playerMonitor.rebind(),await this.playButtonService.smartClick();}playNextLesson(){const t=this.courseDataProvider.getCurrentPosition(this.courseDataProvider.parse());if(!t?.next)return void c.info("æ‰€æœ‰è¯¾ç¨‹å·²æ’­æ”¾å®Œæ¯•");const{chapter:s,lessonIndex:e,lesson:n}=t.next;c.info(`æ’­æ”¾ä¸‹ä¸€èŠ‚: ç¬¬${s.index}ç«  ç¬¬${e+1}èŠ‚ - ${n.name}`);const i=n.element.querySelector(".cg-text-row1");i&&a.safeClick(i)?c.success("å·²ç‚¹å‡»å°èŠ‚: "+n.name):c.error("ç‚¹å‡»å°èŠ‚å¤±è´¥");}};async function m(){try{await p.initialize();}catch(t){c.error("æ’ä»¶åˆå§‹åŒ–å¤±è´¥",t);}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",m):m();

})();